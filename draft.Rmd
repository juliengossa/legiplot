---
title: "Draft"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(ggcpesrthemes)
library(cowplot)


source("R/legiplot_fun_load.R")
lp_modifs <- legiplot_load_csv("data/lp_diff_t.csv")
lp_stats <- legiplot_load_csv("data/lp_diffstats_ts3.csv")

mandats <- read.csv("data/elections.csv") %>% 
  mutate(
    date = as.Date(date),
    président = factor(président, levels=unique(président)) )

lecode = "code de l'éducation"
startdate = as.Date("2017-06-01")

theme_cpesr_setup(authors = "Julien Gossa", source="https://github.com/juliengossa/legiplot")
```

```{r data}
lp_stats <- lp_stats %>%
  mutate(mandat = cut(date, method = "fixed", breaks = mandats$date, labels=head(mandats$président,-1)))
```


```{r check}
lp_modifs %>%
  filter(code == lecode) %>%
  filter(date >= startdate) %>%
  group_by(partie,sous_partie,article,type) %>%
  summarise(nb = n()) %>%
  arrange(desc(nb)) %>%
  head() %>%
  kableExtra::kable()
```


```{r check.2}
lp_modifs %>%
  filter(code == lecode) %>%
  filter(date >= startdate) %>%
  arrange(date) %>%
  group_by(article) %>%
  slice_head() %>% 
  group_by(partie,type) %>%
  summarise(nb = n()) %>%
  kableExtra::kable()
```


```{r check.3}
lp_modifs %>%
  filter(code == lecode) %>%
  filter(date >= startdate) %>%
  arrange(date) %>%
  group_by(article) %>%
  slice_head() %>% 
  group_by(type) %>%
  #group_by(partie,type) %>%
  summarise(nb = n()) %>%
  head() %>%
  kableExtra::kable()
```


```{r check.4}
lp_modifs %>%
  filter(code == lecode) %>%
  filter(date >= startdate) %>%
  arrange(date) %>%
  group_by(article) %>%
  slice_head() %>% 
  group_by(date) %>%
  summarise(nb = n()) %>%
  arrange(desc(nb)) %>%
  head() %>%
  kableExtra::kable() 
```




```{r code, fig.asp=9/16}

left_join(
  lp_modifs %>%
    filter(code == lecode) %>%
    filter(date >= startdate) %>%
    arrange(date) %>%
    group_by(article) %>%
    slice_head() %>% 
    group_by(date,partie,type) %>%
    summarise(nb = n()) %>%
    pivot_wider(names_from = type, values_from = nb, values_fill = c(nb=0))
  ,
  lps <- lp_stats %>%
    filter(code == lecode) %>%
    filter(date >= startdate) %>%
    group_by(date,partie) %>%
    summarise(nb_articles = sum(nb_articles)) 
) %>%
  group_by(partie) %>%
  arrange(date) %>%
  mutate(across(c(Modification,Ajout,Suppression), cumsum)) %>%
  mutate(Conservation = nb_articles - Ajout - Modification) %>%
  pivot_longer(
    c(Modification,Ajout,Suppression,Conservation),
    names_to = "Articles",
    values_to = "Nombre"
  ) %>% 
  mutate(Articles = factor(Articles,
    levels = c("Conservation","Modification","Ajout","Suppression"),
    labels = c("Conservés","Modifiés","Ajoutés","Supprimés")
  )) %>% 
  
  ggplot(aes(x=date,y=Nombre,color=Articles,fill=Articles)) +
    geom_area(aes(group=Articles), position="fill") +
    scale_color_brewer(palette = "Paired") +
    scale_fill_brewer(palette = "Paired") +
    scale_y_continuous(labels = scales::percent) +
    ylab("Proportion des articles") +
    facet_grid(.~partie) +
    ggtitle("Modifications du code de l'éducation sous la présidence d'E. Macron") +
    theme_cpesr_cap()

```




## Jumps

```{r load.jumps}
lpm <- legiplot_load_csv("data/lp_diffstats_jts5.csv") %>%
  group_by(code,date,partie) %>%
  summarise(across(starts_with("nb"),sum)) %>%
  mutate(fin = str_sub(date,1,4)) %>%
  left_join(
    left_join(
      tibble(fin=as.character(seq(1800,2022))),
      mandats %>% 
        mutate(fin=str_sub(lead(date),1,4)) %>% 
        select(-date) ) %>%
      fill(président, .direction="up")
    ) %>%
  mutate(nb_conservations = nb_articles - nb_modifications - nb_ajouts)


lpm.pivot <- lpm %>%
  pivot_longer(c(nb_modifications:nb_suppressions, nb_conservations),
               names_to = "modification", values_to = "articles", names_prefix = "nb_") %>%
  mutate(modification = factor(modification, 
                               levels = c("conservations","modifications","suppressions","ajouts"),
                               labels = c("Conservé","Modifié","Supprimé","Ajouté"))) %>%
  mutate(modification = fct_rev(modification)) %>%
  group_by(code,partie,modification) %>%
  mutate(ratio = articles / lag(nb_articles))
```

```{r check.jumps}
lpm %>%
  group_by(code,partie) %>%
  mutate(check = (nb_articles - (lag(nb_articles) + nb_ajouts - nb_suppressions))) %>%
  filter(check !=0 ) %>% 
  kableExtra::kable()
```


## Code de l'éducation

```{r education, fig.asp=9/16, fig.retina=2}
lpm.pivot %>%
  mutate(articles = ifelse(modification=="Supprimé",-articles,articles)) %>%
  filter(code == "code de l'éducation", partie == "Législative") %>%
  ggplot(aes(x=président,y=articles,fill=modification)) +
    geom_col(color="white", aes(group=modification)) +
    scale_fill_brewer(palette = "Paired", direction = -1, name="Article") +
    xlab("Présidence") + ylab("Nombre d'articles") +
    ggtitle("Modification des articles du Code de l'éducation (partie législative)") +
    theme_cpesr_cap()

```

```{r education.facet}
lpm.pivot %>%
  mutate(articles = ifelse(modification=="Supprimé",-articles,articles)) %>%
  filter(code == "code de l'éducation") %>%
  ggplot(aes(x=président,y=articles,fill=modification)) +
    geom_col() +
    facet_grid(partie~., scales = "free_y") +
    theme_cpesr_cap()

```
 
## Tous les codes dernier mandat

```{r touscodes, fig.width=8, fig.height=8}
lpm.pivot %>%
  filter(partie=="Législative" | code %in% c("code civil", "code de procédure civile")) %>%
  filter(président == "Macron") %>%
  ggplot(aes(x=reorder(code,articles,FUN=sum),y=articles,fill=modification)) +
    geom_col() +
    coord_flip() +
    theme_cpesr_cap()
```

```{r touscodes.ratio, fig.width=8, fig.height=8}
lpm.pivot %>%
  filter(partie=="Législative" | code %in% c("code civil", "code de procédure civile")) %>%
  filter(président == "Macron") %>%
  ggplot(aes(x=reorder(code,ratio,FUN=sum),y=ratio,fill=modification)) +
    geom_col() +
    coord_flip(ylim=c(0,1)) +
    theme_cpesr_cap()
```

```{r touscodes.ratio.2, fig.width=8, fig.asp=1/1}
lpm.sum <- lpm.pivot %>%
  filter(partie=="Législative" | code %in% c("code civil", "code de procédure civile")) %>%
  filter(président %in% c("Chirac 2","Sarkozy","Hollande")) %>%
  group_by(code,président,partie) %>%
  summarise(ratio = sum(ratio))

lpm.pivot %>%
  filter(partie=="Législative" | code %in% c("code civil", "code de procédure civile")) %>%
  filter(président == "Macron") %>%
  ggplot(aes(x=reorder(code,ratio,FUN=sum),y=ratio)) +
    geom_col(aes(fill=modification)) +
    geom_point(data=lpm.sum, aes(shape=président)) +
    coord_flip(ylim=c(0,1)) +
    scale_y_continuous(labels = scales::percent) +
    scale_shape(name="") +
    scale_fill_discrete(name="") +
    ggtitle("Proportion, par code, des articles modifiés durant le mandat de M. Macron", subtitle = "Partie législative seulement") +
    theme_cpesr_cap() +
    theme(legend.justification = "right",
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          plot.title = element_text(hjust = 1)
      ) 
```


```{r touscodes.ratio.3, fig.width=10, fig.asp=2/1}
lpm.pivot %>%
  filter(partie=="Législative" | code %in% c("code civil", "code de procédure civile")) %>%
  filter(président %in% c("Chirac","Chirac 2","Sarkozy","Hollande","Macron")) %>%
  ggplot(aes(x=président,y=ratio)) +
    geom_col(aes(fill=modification)) +
    facet_wrap(code~., ncol=4, labeller = labeller(code=label_wrap_gen(34))) +
    scale_y_continuous(labels = scales::percent) +
    scale_shape(name="") +
    scale_fill_discrete(name="") +
    ggtitle("Proportion, par code, des articles modifiés durant le mandat de M. Macron", subtitle = "Partie législative seulement") +
    theme_cpesr_cap() +
    theme(legend.justification = "right",
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          plot.title = element_text(hjust = 1),
          axis.text.x = element_text(angle=45,hjust=1)
      ) 
```


## Tous les codes tous les mandats

```{r tous.data, fig.width=8, fig.height=8}
lpm %>%
  filter(partie == "Législative") %>%
  mutate(
    Modifiés = nb_modifications,
    Ajoutés = nb_modifications + nb_ajouts,
    Supprimés = nb_modifications + nb_ajouts + nb_suppressions
  ) %>%
  pivot_longer(Modifiés:Supprimés, names_to = "Modification", values_to = "Articles") %>%
  mutate(Modification = factor(Modification, levels=rev(c("Modifiés","Ajoutés","Supprimés")))) %>%
  arrange(Modification) %>%
  ggplot(aes(x=président,y=reorder(code,Articles,FUN=sum), size=Articles, color=Modification)) + 
    geom_point() +
    scale_x_discrete(name="") +
    scale_y_discrete(name="") +
    scale_color_discrete(name="") +
    scale_size(name="") +
    #guides(color = guide_legend(direction="vertical", title=NULL)) +
    theme_cpesr_cap() +
    theme(axis.text.x = element_text(angle=45, hjust=1),
          legend.justification = "right")
```




